<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>Fire-Doc V2 | Professional Inspection Suite</title>
    
    <!-- PWA Metadata -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1042/1042680.png">
    
    <!-- Core Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- React and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .active-scale-95:active { transform: scale(0.95); }
        .active-scale-98:active { transform: scale(0.98); }
        #pwa-toast {
            visibility: hidden;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }
        #pwa-toast.show { visibility: visible; animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <div id="pwa-toast" class="bg-blue-600 text-white px-6 py-4 rounded-3xl shadow-2xl flex items-center gap-4">
        <span class="text-xs font-bold">Add to Home Screen?</span>
        <button onclick="this.parentElement.classList.remove('show')" class="bg-white text-blue-600 px-4 py-1 rounded-full text-[10px] font-black uppercase">Install</button>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fire-doc-v2-prod';

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const App = () => {
            const [user, setUser] = useState(null);
            const [inspections, setInspections] = useState([]);
            const [view, setView] = useState('years'); 
            const [activeYear, setActiveYear] = useState('2025');
            const [loading, setLoading] = useState(true);

            // Auth Logic
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) { console.error("Auth error:", e); }
                };
                initAuth();
                return auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if (u) setLoading(false);
                });
            }, []);

            // Data Listener + Baseline Creator
            useEffect(() => {
                if (!user) return;
                const path = `artifacts/${appId}/public/data/inspections`;
                const unsubscribe = db.collection(path).onSnapshot(snap => {
                    const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    
                    if (docs.length === 0) {
                        // Create baseline if DB is empty to prevent white screen
                        db.collection(path).add({
                            name: "LDS Church Welling FM Group",
                            year: "2025",
                            address: "Champion, Alberta",
                            completed: false,
                            timestamp: Date.now()
                        });
                    } else {
                        setInspections(docs);
                    }
                }, err => {
                    console.error("Firestore error:", err);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Initializing Session</p>
                        </div>
                    </div>
                );
            }

            if (view === 'years') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-50">
                        <img src="https://cdn-icons-png.flaticon.com/512/1042/1042680.png" className="w-20 h-20 mb-6 shadow-2xl rounded-3xl" alt="Logo" />
                        <h1 className="text-3xl font-black text-slate-800 uppercase mb-2 tracking-tighter">Fire-Doc</h1>
                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-10">Professional Inspection Suite</p>
                        <div className="w-full max-w-xs space-y-4">
                            {['2024', '2025', '2026'].map(year => (
                                <button key={year} onClick={() => { setActiveYear(year); setView('buildings'); }} 
                                    className="w-full bg-white p-6 rounded-[32px] shadow-sm flex items-center justify-between font-black text-slate-700 active-scale-95 border border-slate-100 transition-all">
                                    <span className="flex items-center gap-3"><Icon name="calendar" className="text-blue-500" /> {year} CYCLE</span>
                                    <Icon name="chevron-right" className="text-slate-300" />
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (view === 'buildings') {
                const filtered = inspections.filter(i => i.year === activeYear);
                return (
                    <div className="min-h-screen bg-slate-50">
                        <header className="bg-blue-600 text-white p-10 pb-20 rounded-b-[60px] shadow-xl relative overflow-hidden">
                            <div className="absolute top-[-20px] right-[-20px] w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                            <button onClick={() => setView('years')} className="text-[10px] font-black uppercase opacity-60 mb-4 flex items-center gap-2">
                                <Icon name="arrow-left" size={12} /> Back
                            </button>
                            <h2 className="text-3xl font-black uppercase tracking-tight">{activeYear} Properties</h2>
                        </header>
                        <div className="p-6 -mt-10 space-y-4 pb-24">
                            {filtered.length > 0 ? filtered.map(b => (
                                <div key={b.id} className="bg-white p-6 rounded-[35px] shadow-lg flex items-center justify-between active-scale-98 transition-all border border-slate-50">
                                    <div className="flex items-center gap-5">
                                        <div className="bg-blue-50 p-4 rounded-2xl text-blue-600 shadow-inner"><Icon name="building" size={28} /></div>
                                        <div>
                                            <h3 className="font-black text-slate-800 uppercase leading-tight text-sm">{b.name}</h3>
                                            <p className="text-[9px] text-slate-400 font-bold uppercase mt-1">{b.address || 'Address Not Set'}</p>
                                        </div>
                                    </div>
                                    <Icon name="chevron-right" className="text-slate-200" />
                                </div>
                            )) : (
                                <div className="bg-white/50 border-2 border-dashed border-slate-200 rounded-[40px] p-16 text-center">
                                    <Icon name="search" size={40} className="mx-auto text-slate-200 mb-4" />
                                    <p className="text-[10px] text-slate-400 font-black uppercase tracking-widest">No Buildings Indexed</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            setTimeout(() => document.getElementById('pwa-toast').classList.add('show'), 3000);
        });
    </script>
    
    <!-- Deferred Libraries -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
