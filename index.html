<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>Fire-Doc V2 | Professional Inspection Suite</title>
    
    <!-- Link to the Manifest JSON you shared -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1042/1042680.png">
    
    <!-- CSS and Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- React and Babel CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .active-scale-95:active { transform: scale(0.95); }
        .active-scale-98:active { transform: scale(0.98); }
        
        /* PWA Install Prompt Simulation */
        #pwa-toast {
            visibility: hidden;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }
        #pwa-toast.show { visibility: visible; animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <!-- PWA Install Prompt -->
    <div id="pwa-toast" class="bg-blue-600 text-white px-6 py-4 rounded-3xl shadow-2xl flex items-center gap-4">
        <span class="text-xs font-bold">Add to Home Screen?</span>
        <button onclick="this.parentElement.classList.remove('show')" class="bg-white text-blue-600 px-4 py-1 rounded-full text-[10px] font-black uppercase">Install</button>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Icon Helper
        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        // Firebase Config
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fire-alarm-inspector-v3';

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const TARGET_FOLDER_URL = "https://drive.google.com/drive/u/0/folders/11lj4d0lemmAo9h1xgfXxLtWviTHD4syF";

        const DEVICE_TYPES = [
            { code: 'H', label: 'Manual Pull Station' },
            { code: 'S', label: 'Smoke Detector' },
            { code: 'FS', label: 'Flow Switch' },
            { code: 'TS', label: 'Tamper Switch' },
            { code: 'B', label: 'Bell' },
            { code: 'V', label: 'Visual Appliance' }
        ];

        const App = () => {
            const [user, setUser] = useState(null);
            const [inspections, setInspections] = useState([]);
            const [allMedia, setAllMedia] = useState([]);
            const [view, setView] = useState('years'); 
            const [selectedBuildingId, setSelectedBuildingId] = useState(null);
            const [activeYear, setActiveYear] = useState('2025');
            const fileInputRef = useRef(null);
            
            const [dialogue, setDialogue] = useState({ isOpen: false, title: '', message: '', onConfirm: null });
            const [openSections, setOpenSections] = useState({ details: true });

            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged(setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const path = `artifacts/${appId}/public/data/inspections`;
                return db.collection(path).onSnapshot(snap => {
                    const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setInspections(docs);
                });
            }, [user]);

            const triggerDialogue = (config) => setDialogue({ ...config, isOpen: true });
            const closeDialogue = () => setDialogue(prev => ({ ...prev, isOpen: false }));

            // App Views
            if (view === 'years') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-50">
                        <img src="https://cdn-icons-png.flaticon.com/512/1042/1042680.png" className="w-24 h-24 mb-6" alt="Logo" />
                        <h1 className="text-2xl font-black text-slate-800 uppercase mb-8">Fire-Doc Inspector</h1>
                        <div className="w-full max-w-xs space-y-4">
                            {['2024', '2025', '2026'].map(year => (
                                <button key={year} onClick={() => { setActiveYear(year); setView('buildings'); }} className="w-full bg-white p-6 rounded-[32px] shadow-sm flex items-center justify-between font-black text-slate-700 active-scale-95 transition-all">
                                    {year} Inspection Cycle <Icon name="chevron-right" />
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (view === 'buildings') {
                const filtered = inspections.filter(i => i.year === activeYear);
                return (
                    <div className="min-h-screen">
                        <header className="bg-blue-600 text-white p-10 pb-20 rounded-b-[60px] shadow-lg">
                            <button onClick={() => setView('years')} className="text-[10px] font-black uppercase opacity-60 mb-4">Back</button>
                            <h2 className="text-3xl font-black uppercase tracking-tight">Properties</h2>
                        </header>
                        <div className="p-6 -mt-10 space-y-4">
                            {filtered.length > 0 ? filtered.map(b => (
                                <div key={b.id} onClick={() => { setSelectedBuildingId(b.id); setView('inspect'); }} className="bg-white p-6 rounded-[32px] shadow-md flex items-center justify-between">
                                    <div className="flex items-center gap-4">
                                        <div className="bg-blue-50 p-3 rounded-2xl text-blue-600"><Icon name="building" size={24} /></div>
                                        <span className="font-black text-slate-800 uppercase text-sm">{b.name}</span>
                                    </div>
                                    <Icon name="chevron-right" className="text-slate-300" />
                                </div>
                            )) : (
                                <div className="text-center p-12 text-slate-300 font-black uppercase text-xs">No Records Found</div>
                            )}
                        </div>
                    </div>
                );
            }

            return <div className="p-10 text-center font-black text-slate-400">Loading Inspection Interface...</div>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Handle PWA Install Display
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            setTimeout(() => document.getElementById('pwa-toast').classList.add('show'), 3000);
        });
    </script>
    
    <!-- PDF and Icons Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</body>
</html>
